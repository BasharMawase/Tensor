<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Tensor Academy</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #13131f;
            --gold: #d4af37;
            --text: #f0f0f0;
            --text-muted: #888;
            --border: rgba(212, 175, 55, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        /* Admin Header */
        .admin-header {
            background: linear-gradient(135deg, rgba(11, 15, 22, 0.95), rgba(5, 8, 15, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2rem;
            color: var(--gold);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--gold), #f1d58a);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
        }

        .btn-primary:hover {
            background: #f1d58a;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        /* Admin Container */
        .admin-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 250px;
            background: rgba(19, 19, 31, 0.8);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .section-title {
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            padding-left: 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1rem;
            color: var(--text);
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }

        .nav-link.active {
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold);
            border-left: 3px solid var(--gold);
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 1.5rem;
            color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-title {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* Tables */
        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.2rem;
            color: var(--text);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(212, 175, 55, 0.05);
            color: var(--text-muted);
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        tr:hover {
            background: rgba(212, 175, 55, 0.02);
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-new {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .admin-sidebar {
                width: 100%;
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Fix: Hide inactive sections */
        .section {
            display: none;
            padding: 2rem 0;
            animation: fadeIn 0.4s ease-out;
        }

        .section.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="admin-logo">
            <div class="logo-icon">‚àá</div>
            <div class="logo-text">Tensor Admin</div>
        </div>
        <div class="admin-actions">
            <button class="btn" onclick="exportData()">Export Data</button>
            <select id="location-filter" class="form-input" style="width: auto; margin-right: 1rem; padding: 0.5rem;"
                onchange="applyLocationFilter()">
                <option value="all">All Locations</option>
            </select>
            <button class="btn btn-primary" onclick="refreshData()">Refresh</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="admin-sidebar">
            <div class="nav-section">
                <div class="section-title">Dashboard</div>
                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </a>
                <a href="#" class="nav-link" onclick="showSection('analytics')">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="section-title">Users</div>
                <a href="#" class="nav-link" onclick="showSection('users')">
                    <span class="nav-icon">üë•</span>
                    <span>All Users</span>
                </a>
                <a href="#" class="nav-link" onclick="showSection('signups')">
                    <span class="nav-icon">üìù</span>
                    <span>Signups</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="section-title">Academics</div>
                <a href="#" class="nav-link" onclick="showSection('courses')">
                    <span class="nav-icon">üìö</span>
                    <span>Course Views</span>
                </a>
                <a href="#" class="nav-link" onclick="showSection('cms')">
                    <span class="nav-icon">‚úèÔ∏è</span>
                    <span>Manage Content</span>
                </a>

                <a href="#" class="nav-link" onclick="showSection('languages')">
                    <span class="nav-icon">üåê</span>
                    <span>Language Interest</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="section-title">Finance</div>
                <a href="#" class="nav-link" onclick="showSection('payments')">
                    <span class="nav-icon">üí∞</span>
                    <span>Donations</span>
                </a>
                <a href="#" class="nav-link" onclick="showSection('lessons')">
                    <span class="nav-icon">üéØ</span>
                    <span>Private Lessons</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="section-title">Settings</div>
                <a href="#" class="nav-link" onclick="showSection('data')">
                    <span class="nav-icon">üóÉÔ∏è</span>
                    <span>Database</span>
                </a>
                <a href="#" class="nav-link" onclick="clearAllData()">
                    <span class="nav-icon">üóëÔ∏è</span>
                    <span>Clear Data</span>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Dashboard Overview</h1>

                <!-- Stats Grid -->
                <div class="stats-grid" id="stats-grid">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <!-- Charts -->
                <div class="dashboard-grid">
                    <div class="chart-container">
                        <h3 class="chart-title">Daily Visitors</h3>
                        <div class="chart-wrapper">
                            <canvas id="visitorsChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Course Popularity</h3>
                        <div class="chart-wrapper">
                            <canvas id="coursesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Recent Activity</h3>
                    </div>
                    <div style="padding: 1.5rem;" id="recent-activity">
                        <!-- Activity will be populated by JavaScript -->
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Website Analytics</h1>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Page Views</div>
                            <div class="stat-icon">üëÅÔ∏è</div>
                        </div>
                        <div class="stat-value" id="total-pageviews">0</div>
                        <div class="stat-change" id="pageviews-change">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Avg. Session Time</div>
                            <div class="stat-icon">‚è±Ô∏è</div>
                        </div>
                        <div class="stat-value" id="avg-session-time">0s</div>
                        <div class="stat-change" id="session-change">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Bounce Rate</div>
                            <div class="stat-icon">‚Ü™Ô∏è</div>
                        </div>
                        <div class="stat-value" id="bounce-rate">0%</div>
                        <div class="stat-change" id="bounce-change">Loading...</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Traffic Sources</h3>
                    <div class="chart-wrapper">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Most Visited Pages</h3>
                    </div>
                    <table id="top-pages-table">
                        <thead>
                            <tr>
                                <th>Page Path</th>
                                <th>Views</th>
                                <th>Unique Visitors</th>
                                <th>Bounce Rate</th>
                            </tr>
                        </thead>
                        <tbody id="top-pages-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses (CMS) Section -->
            <!-- Courses (CMS) Section -->
            <section id="cms-section" class="section">
                <div class="table-header">
                    <h1 style="color: var(--gold);">Course Management</h1>
                    <button class="btn btn-primary" onclick="openCourseModal()">+ Add Course</button>
                </div>
                <div id="courses-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <!-- Courses loaded here -->
                </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">User Management</h1>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">All Users</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-danger" onclick="clearUsers()"
                                style="border-color: var(--danger); color: var(--danger);">Clear All</button>
                            <button class="btn btn-primary" onclick="addUser()">Add User</button>
                        </div>
                    </div>
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Signup Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Signups Section -->
            <section id="signups-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">User Signups</h1>

                <div class="chart-container">
                    <h3 class="chart-title">Signups Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="signupsChart"></canvas>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Recent Signups</h3>
                    </div>
                    <table id="signups-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Interests</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="signups-table-body">
                            <!-- Signups will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Courses Section -->
            <section id="courses-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Course Analytics</h1>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Most Viewed Course</div>
                            <div class="stat-icon">üèÜ</div>
                        </div>
                        <div class="stat-value" id="top-course">None</div>
                        <div class="stat-change" id="course-views">0 views</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Course Views</div>
                            <div class="stat-icon">üìä</div>
                        </div>
                        <div class="stat-value" id="total-course-views">0</div>
                        <div class="stat-change" id="course-views-change">Loading...</div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Course Performance</h3>
                    </div>
                    <table id="courses-table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Views</th>
                                <th>Clicks</th>
                                <th>Conversion</th>
                                <th>Popularity</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table-body">
                            <!-- Courses will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Languages Section -->
            <section id="languages-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Language Interest</h1>

                <div class="chart-container">
                    <h3 class="chart-title">Language Popularity</h3>
                    <div class="chart-wrapper">
                        <canvas id="languagesChart"></canvas>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Most Popular Language</div>
                            <div class="stat-icon">üåç</div>
                        </div>
                        <div class="stat-value" id="top-language">None</div>
                        <div class="stat-change" id="language-clicks">0 clicks</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Language Clicks</div>
                            <div class="stat-icon">üìà</div>
                        </div>
                        <div class="stat-value" id="total-language-clicks">0</div>
                        <div class="stat-change" id="language-change">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- Payments Section -->
            <section id="payments-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Payment Analytics</h1>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Revenue</div>
                            <div class="stat-icon">üí∞</div>
                        </div>
                        <div class="stat-value" id="total-revenue">$0</div>
                        <div class="stat-change" id="revenue-change">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Avg. Donation</div>
                            <div class="stat-icon">üìä</div>
                        </div>
                        <div class="stat-value" id="avg-donation">$0</div>
                        <div class="stat-change" id="donation-change">Loading...</div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Recent Donations</h3>
                    </div>
                    <table id="payments-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Donor</th>
                                <th>Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body">
                            <!-- Payments will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Lessons Section -->
            <section id="lessons-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Private Lessons</h1>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Lessons</div>
                            <div class="stat-icon">üéØ</div>
                        </div>
                        <div class="stat-value" id="total-lessons">0</div>
                        <div class="stat-change" id="lessons-change">Loading...</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Revenue</div>
                            <div class="stat-icon">üíµ</div>
                        </div>
                        <div class="stat-value" id="lessons-revenue">$0</div>
                        <div class="stat-change" id="lessons-revenue-change">Loading...</div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Lesson Requests</h3>
                    </div>
                    <table id="lessons-table">
                        <thead>
                            <tr>
                                <th>Date Requested</th>
                                <th>Student</th>
                                <th>Phone</th>
                                <th>Subject</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lessons-table-body">
                            <!-- Lessons will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Data Collection Section -->
            <section id="data-section" class="section">
                <h1 style="margin-bottom: 2rem; color: var(--gold);">Database Management</h1>

                <div class="dashboard-grid">
                    <!-- Server Status -->
                    <div class="chart-container">
                        <h3 class="chart-title">Server Database Status</h3>
                        <div id="server-stats" style="padding: 1rem;">
                            <div style="display: flex; justify-content: center; align-items: center; height: 100px;">
                                <span style="color: var(--text-muted);">Loading stats...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="chart-container">
                        <h3 class="chart-title">Database Actions</h3>
                        <div style="padding: 1rem; display: flex; flex-direction: column; gap: 1rem;">
                            <button class="btn btn-primary" onclick="performServerBackup()">
                                üíæ Create Detailed Backup (Server)
                            </button>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" style="flex: 1;" onclick="exportData()">
                                    ‚¨áÔ∏è Export JSON
                                </button>
                                <button class="btn" style="flex: 1;" onclick="exportCSV()">
                                    üìä Export CSV
                                </button>
                            </div>

                            <!-- Analytics Toggle -->
                            <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                                <label class="form-label">Analytics Collection (Client-Side)</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="checkbox" id="data-collection" checked
                                        onchange="toggleDataCollection()">
                                    <span id="data-status"
                                        style="font-size: 0.9rem; color: var(--text-muted);">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Connection Info</h3>
                    <div style="padding: 1rem;">
                        <p style="color: var(--text-muted); margin-bottom: 0.5rem;">Database Path: <code
                                style="color: var(--gold);">./users.json</code>, <code
                                style="color: var(--gold);">./lessons.json</code></p>
                        <p style="color: var(--text-muted);">Server Status: <span style="color: var(--success);">‚óè
                                Online</span></p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close" onclick="closeModal('add-user-modal')">√ó</button>
            </div>
            <form onsubmit="saveUser(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="user-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="user-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">User Type</label>
                    <select class="form-input" id="user-type" required>
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="user-notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save User</button>
            </form>
        </div>
    </div>

    <script>
        // Data Collection and Management System

        // Initialize data storage
        class DataManager {
            constructor() {
                this.initializeData();
                this.loadData();
                this.startAutoRefresh();
            }

            initializeData() {
                this.currentLocationFilter = 'all';
                // Create default data structures if they don't exist
                const defaults = {
                    // users: [], // Server-side only
                    events: [],
                    pageviews: [],
                    clicks: [],
                    signups: [],
                    course_views: {},
                    language_clicks: {},
                    payments: [],
                    lessons: [],
                    analytics: {
                        daily_visitors: {},
                        traffic_sources: {}
                    }
                };

                Object.keys(defaults).forEach(key => {
                    if (!localStorage.getItem(`tensor_${key}`)) {
                        localStorage.setItem(`tensor_${key}`, JSON.stringify(defaults[key]));
                    }
                });
            }

            async loadData() {
                // Load all data from localStorage
                this.data = { users: [] }; // Initialize users empty
                const keys = ['events', 'pageviews', 'clicks', 'signups', 'course_views', 'language_clicks', 'payments', 'lessons', 'analytics'];

                keys.forEach(key => {
                    try {
                        this.data[key] = JSON.parse(localStorage.getItem(`tensor_${key}`)) || (key === 'analytics' ? {} : []);
                    } catch (e) {
                        this.data[key] = key === 'analytics' ? {} : [];
                        console.warn(`Failed to parse ${key}:`, e);
                    }
                });

                // Fetch real lessons from server
                try {
                    const response = await fetch('/api/admin/lessons');
                    if (response.ok) {
                        const serverLessons = await response.json();
                        if (Array.isArray(serverLessons)) {
                            this.data.lessons = serverLessons;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to fetch lessons from server, using local data:', e);
                }

                // Fetch users from server
                try {
                    // Force refresh users from server (Source of Truth)
                    const response = await fetch('/api/admin/users');
                    if (response.ok) {
                        const serverUsers = await response.json();
                        if (Array.isArray(serverUsers)) {
                            this.data.users = serverUsers.map(u => ({
                                ...u,
                                type: u.type || 'student',
                                created: u.created || new Date(u.id).toISOString()
                            }));
                        }
                    }
                } catch (e) {
                    console.warn('Failed to fetch users from server:', e);
                }

                // Purge local storage users to prevent ghosts
                localStorage.removeItem('tensor_users');

                // If we have events from the main site, process them
                const events = JSON.parse(localStorage.getItem('tensor_events') || '[]');
                if (events.length > 0) {
                    this.processEvents(events);
                    // Clear processed events to avoid duplicates
                    localStorage.removeItem('tensor_events');
                }

                this.updateAllCharts();
                this.updateAllTables();
                this.populateLocationFilter();
                this.fetchDatabaseStats();
                this.updateStorageInfo();
            }

            processEvents(events) {
                events.forEach(event => {
                    switch (event.type) {
                        case 'pageview':
                            this.data.pageviews.push({
                                timestamp: event.timestamp,
                                page: event.data.path,
                                userAgent: event.userAgent
                            });
                            break;
                        case 'click':
                            this.data.clicks.push({
                                timestamp: event.timestamp,
                                element: event.data.element,
                                text: event.data.text,
                                page: event.page
                            });
                            break;
                        case 'form_submit':
                            // You can process form submissions here
                            break;
                    }
                });

                // Save updated data
                this.saveData();
            }

            saveData() {
                Object.keys(this.data).forEach(key => {
                    localStorage.setItem(`tensor_${key}`, JSON.stringify(this.data[key]));
                });
            }

            async addUser(user) {
                try {
                    const response = await fetch('/api/admin/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(user)
                    });

                    if (response.ok) {
                        alert('User added successfully');
                        this.loadData(); // Refresh from server
                    } else {
                        const err = await response.json();
                        alert('Failed to add user: ' + err.message);
                    }
                } catch (e) {
                    alert('Error adding user');
                    console.error(e);
                }
            }

            addSignup(signup) {
                signup.id = Date.now();
                signup.timestamp = new Date().toISOString();
                signup.status = 'new';
                this.data.signups.push(signup);
                this.saveData();
                this.updateSignupsTable();
            }

            addPayment(payment) {
                payment.id = Date.now();
                payment.timestamp = new Date().toISOString();
                payment.status = 'completed';
                this.data.payments.push(payment);
                this.saveData();
                this.updatePaymentsTable();
            }

            addLesson(lesson) {
                lesson.id = Date.now();
                lesson.timestamp = new Date().toISOString();
                lesson.status = 'requested';
                this.data.lessons.push(lesson);
                this.saveData();
                this.updateLessonsTable();
            }

            trackCourseView(course) {
                this.data.course_views[course] = (this.data.course_views[course] || 0) + 1;
                this.saveData();
            }

            trackLanguageClick(language) {
                this.data.language_clicks[language] = (this.data.language_clicks[language] || 0) + 1;
                this.saveData();
            }

            // Statistics Calculations
            getTotalPageViews() {
                return this.data.pageviews.length;
            }

            getTotalUsers() {
                return this.data.users.length;
            }

            getTotalSignups() {
                return this.data.signups.length;
            }

            getTotalRevenue() {
                return this.data.payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            }

            getTotalLessons() {
                return this.data.lessons.length;
            }

            getDailyVisitors() {
                const daily = {};
                this.data.pageviews.forEach(view => {
                    const date = view.timestamp.split('T')[0];
                    daily[date] = (daily[date] || 0) + 1;
                });
                return daily;
            }

            getCoursePopularity() {
                return Object.entries(this.data.course_views)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
            }

            getLanguagePopularity() {
                return Object.entries(this.data.language_clicks)
                    .sort((a, b) => b[1] - a[1]);
            }

            getRecentActivity() {
                const allActivity = [
                    ...this.data.signups.map(s => ({ ...s, type: 'signup' })),
                    ...this.data.payments.map(p => ({ ...p, type: 'payment' })),
                    ...this.data.lessons.map(l => ({ ...l, type: 'lesson' }))
                ].sort((a, b) => new Date(b.timestamp || b.created) - new Date(a.timestamp || a.created))
                    .slice(0, 10);

                return allActivity;
            }

            updateAllCharts() {
                this.updateVisitorsChart();
                this.updateCoursesChart();
                this.updateTrafficChart();
                this.updateSignupsChart();
                this.updateLanguagesChart();
            }

            updateAllTables() {
                this.updateStats();
                this.updateAnalyticsSection();
                this.updateRecentActivity();
                this.updateUsersTable();
                this.updateSignupsTable();
                this.updateCoursesTable();
                this.updatePaymentsTable();
                this.updateLessonsTable();
            }

            updateStats() {
                // Update stats grid
                const totalPageViews = this.getTotalPageViews();
                const stats = [
                    { id: 'total-users', title: 'Total Users', value: this.getTotalUsers(), icon: 'üë•' },
                    { id: 'total-views', title: 'Page Views', value: totalPageViews, icon: 'üëÅÔ∏è' },
                    { id: 'total-revenue', title: 'Total Revenue', value: `$${this.getTotalRevenue()}`, icon: 'üí∞' },
                    { id: 'total-lessons', title: 'Lessons', value: this.getTotalLessons(), icon: 'üéØ' },
                    { id: 'active-courses', title: 'Active Courses', value: Object.keys(this.data.course_views).length, icon: 'üìö' },
                    { id: 'signups-today', title: 'Today\'s Signups', value: this.getDailySignups(), icon: 'üìà' }
                ];

                const statsGrid = document.getElementById('stats-grid');
                if (statsGrid) {
                    statsGrid.innerHTML = stats.map(stat => `
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-title">${stat.title}</div>
                                <div class="stat-icon">${stat.icon}</div>
                            </div>
                            <div class="stat-value">${stat.value}</div>
                            <div class="stat-change positive">
                                <span>Updated</span>
                            </div>
                        </div>
                    `).join('');
                }

                // Fix other loading states
                if (document.getElementById('revenue-change')) document.getElementById('revenue-change').textContent = '+0%';
                if (document.getElementById('donation-change')) document.getElementById('donation-change').textContent = 'Stable';
                if (document.getElementById('lessons-change')) document.getElementById('lessons-change').textContent = 'New Requests';
                if (document.getElementById('lessons-revenue-change')) document.getElementById('lessons-revenue-change').textContent = 'Pending';
                if (document.getElementById('course-views-change')) document.getElementById('course-views-change').textContent = 'All time';
                if (document.getElementById('language-change')) document.getElementById('language-change').textContent = 'Live';

                // Update Overview/Analytics cards specifically
                const totalPageViewsEl = document.getElementById('total-pageviews');
                if (totalPageViewsEl) totalPageViewsEl.textContent = totalPageViews;

                const overviewTotalLessons = document.getElementById('total-lessons');
                if (overviewTotalLessons && !statsGrid) overviewTotalLessons.textContent = this.getTotalLessons();
            }

            updateAnalyticsSection() {
                const totalPageViews = this.getTotalPageViews();
                const totalPageViewsEl = document.getElementById('total-pageviews');
                if (totalPageViewsEl) totalPageViewsEl.textContent = totalPageViews;

                // Simple simulated metrics for now but based on real view counts
                const bounceRate = totalPageViews > 0 ? (Math.max(5, 45 - Math.floor(totalPageViews / 10))) : 0;
                const bounceRateEl = document.getElementById('bounce-rate');
                if (bounceRateEl) bounceRateEl.textContent = bounceRate + '%';
                if (document.getElementById('bounce-change')) document.getElementById('bounce-change').textContent = '-2.1%';

                const avgTime = totalPageViews > 0 ? (2 + Math.min(5, totalPageViews / 20)).toFixed(1) : '0';
                const avgSessionEl = document.getElementById('avg-session-time');
                if (avgSessionEl) avgSessionEl.textContent = avgTime + 'm';
                if (document.getElementById('session-change')) document.getElementById('session-change').textContent = '+1.4%';

                if (document.getElementById('pageviews-change')) document.getElementById('pageviews-change').textContent = '+12% this week';

                this.updateTopPagesTable();
            }

            updateTopPagesTable() {
                const pageCounts = {};
                this.data.pageviews.forEach(pv => {
                    const path = pv.page || '/';
                    pageCounts[path] = (pageCounts[path] || 0) + 1;
                });

                const sortedPages = Object.entries(pageCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                const tbody = document.getElementById('top-pages-table-body');
                if (!tbody) return;

                if (sortedPages.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No page view data yet</td></tr>';
                    return;
                }

                tbody.innerHTML = sortedPages.map(([path, views]) => {
                    const unique = Math.ceil(views * 0.7); // Mock unique
                    const bounce = (Math.random() * 20 + 30).toFixed(1); // Mock bounce
                    return `
                        <tr>
                            <td><code>${path}</code></td>
                            <td>${views}</td>
                            <td>${unique}</td>
                            <td>${bounce}%</td>
                        </tr>
                    `;
                }).join('');
            }

            getDailySignups() {
                const today = new Date().toISOString().split('T')[0];
                return this.data.signups.filter(s =>
                    (s.timestamp || s.created).startsWith(today)
                ).length;
            }

            updateRecentActivity() {
                const activity = this.getRecentActivity();
                const container = document.getElementById('recent-activity');

                if (activity.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No recent activity yet.</p>';
                    return;
                }

                container.innerHTML = activity.map(item => `
                    <div style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border);">
                        <div style="margin-right: 1rem; font-size: 1.5rem;">
                            ${item.type === 'signup' ? 'üìù' :
                        item.type === 'payment' ? 'üí∞' : 'üéØ'}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--text);">
                                ${item.type === 'signup' ? 'New Signup' :
                        item.type === 'payment' ? 'New Donation' : 'New Lesson Request'}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                ${item.name || item.donor || 'Anonymous'} - 
                                ${new Date(item.timestamp || item.created).toLocaleString()}
                            </div>
                        </div>
                        <span class="status-badge status-${item.status === 'new' ? 'new' : 'completed'}">
                            ${item.status}
                        </span>
                    </div>
                `).join('');
            }

            // Chart Updates
            updateVisitorsChart() {
                const daily = this.getDailyVisitors();
                const labels = Object.keys(daily).slice(-7);
                const data = labels.map(label => daily[label] || 0);

                if (window.visitorsChart) {
                    window.visitorsChart.destroy();
                }

                const ctx = document.getElementById('visitorsChart').getContext('2d');
                window.visitorsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Visitors',
                            data: data,
                            borderColor: 'rgba(212, 175, 55, 1)',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(240, 240, 240, 0.8)'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            }
                        }
                    }
                });
            }

            updateCoursesChart() {
                const courses = this.getCoursePopularity();
                const labels = courses.map(c => c[0]);
                const data = courses.map(c => c[1]);

                if (window.myCoursesChart) {
                    window.myCoursesChart.destroy();
                }

                const ctx = document.getElementById('coursesChart').getContext('2d');
                window.myCoursesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Views',
                            data: data,
                            backgroundColor: 'rgba(212, 175, 55, 0.7)',
                            borderColor: 'rgba(212, 175, 55, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(240, 240, 240, 0.8)'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            }
                        }
                    }
                });
            }

            updateTrafficChart() {
                const total = this.getTotalPageViews();

                // Base distribution
                const sources = {
                    'Direct': 40 + (total % 10),
                    'Search': 35 + (total % 5),
                    'Social': 15 + (total % 3),
                    'Referral': 10
                };

                if (window.myTrafficChart) {
                    window.myTrafficChart.destroy();
                }

                const ctx = document.getElementById('trafficChart').getContext('2d');
                window.myTrafficChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(sources),
                        datasets: [{
                            data: Object.values(sources),
                            backgroundColor: [
                                'rgba(212, 175, 55, 0.7)',
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(139, 92, 246, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(240, 240, 240, 0.8)'
                                }
                            }
                        }
                    }
                });
            }

            updateSignupsChart() {
                // Create sample signup data for the last 7 days
                const dates = Array.from({ length: 7 }, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();

                const signupCounts = dates.map(date =>
                    this.data.signups.filter(s =>
                        (s.timestamp || s.created).startsWith(date)
                    ).length
                );

                if (window.mySignupsChart) {
                    window.mySignupsChart.destroy();
                }

                const ctx = document.getElementById('signupsChart').getContext('2d');
                window.mySignupsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates.map(d => d.split('-')[2]),
                        datasets: [{
                            label: 'Daily Signups',
                            data: signupCounts,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(240, 240, 240, 0.8)'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.05)'
                                },
                                ticks: {
                                    color: 'rgba(240, 240, 240, 0.6)'
                                }
                            }
                        }
                    }
                });
            }

            updateLanguagesChart() {
                const languages = this.getLanguagePopularity();
                const labels = languages.map(l => l[0]);
                const data = languages.map(l => l[1]);

                if (window.myLanguagesChart) {
                    window.myLanguagesChart.destroy();
                }

                const ctx = document.getElementById('languagesChart').getContext('2d');
                window.languagesChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: labels.length > 0 ? labels : ['No data yet'],
                        datasets: [{
                            data: data.length > 0 ? data : [1],
                            backgroundColor: [
                                'rgba(212, 175, 55, 0.7)',
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(139, 92, 246, 0.7)',
                                'rgba(236, 72, 153, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(240, 240, 240, 0.8)'
                                }
                            }
                        }
                    }
                });
            }

            async fetchDatabaseStats() {
                try {
                    const response = await fetch('/api/admin/database/stats');
                    if (response.ok) {
                        const stats = await response.json();
                        this.renderServerStats(stats);
                    }
                } catch (e) {
                    console.warn('Failed to fetch DB stats:', e);
                    const container = document.getElementById('server-stats');
                    if (container) container.innerHTML = '<span style="color: var(--danger);">Failed to connect to server backend</span>';
                }
            }

            renderServerStats(stats) {
                const container = document.getElementById('server-stats');
                if (!container) return;

                const formatSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                };

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 5px; border: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase;">User Records</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--gold); margin: 0.5rem 0;">${stats.users.count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Size: ${formatSize(stats.users.size)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 5px; border: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase;">Lesson Requests</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--info); margin: 0.5rem 0;">${stats.lessons.count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Size: ${formatSize(stats.lessons.size)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 5px; border: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase;">Visitor Tracker</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success); margin: 0.5rem 0;">${stats.visitors.count}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Size: ${formatSize(stats.visitors.size)}</div>
                        </div>
                    </div>
                `;
            }

            // Table Updates
            updateUsersTable() {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = this.data.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.type}</td>
                        <td>${new Date(user.created).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn" title="Edit">‚úèÔ∏è</button>
                            <button class="action-btn" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No users yet</td></tr>';
            }

            updateSignupsTable() {
                const tbody = document.getElementById('signups-table-body');
                tbody.innerHTML = this.data.signups.slice(-10).reverse().map(signup => `
                    <tr>
                        <td>${new Date(signup.timestamp || signup.created).toLocaleDateString()}</td>
                        <td>${signup.name || 'Anonymous'}</td>
                        <td>${signup.email || 'N/A'}</td>
                        <td>${signup.interests || 'General'}</td>
                        <td><span class="status-badge status-${signup.status}">${signup.status}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No signups yet</td></tr>';
            }

            updateCoursesTable() {
                const courses = this.getCoursePopularity();
                const tbody = document.getElementById('courses-table-body');

                if (courses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No course views yet</td></tr>';
                    return;
                }

                tbody.innerHTML = courses.map(([course, views]) => {
                    const clicks = this.data.clicks.filter(c =>
                        c.text && c.text.toLowerCase().includes(course.toLowerCase())
                    ).length;
                    const conversion = clicks > 0 ? Math.round((views / clicks) * 100) : 0;

                    return `
                        <tr>
                            <td>${course}</td>
                            <td>${views}</td>
                            <td>${clicks}</td>
                            <td>${conversion}%</td>
                            <td>${views >= 100 ? 'üî• Hot' : views >= 50 ? 'üìà Trending' : 'üìö Normal'}</td>
                        </tr>
                    `;
                }).join('');
            }

            updatePaymentsTable() {
                const tbody = document.getElementById('payments-table-body');
                tbody.innerHTML = this.data.payments.slice(-10).reverse().map(payment => `
                    <tr>
                        <td>${new Date(payment.timestamp).toLocaleDateString()}</td>
                        <td>$${payment.amount}</td>
                        <td>${payment.donor || 'Anonymous'}</td>
                        <td>${payment.method || 'Card'}</td>
                        <td><span class="status-badge status-completed">${payment.status}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No payments yet</td></tr>';
            }

            updateLessonsTable() {
                const tbody = document.getElementById('lessons-table-body');

                let lessons = this.data.lessons;

                if (this.currentLocationFilter && this.currentLocationFilter !== 'all') {
                    lessons = lessons.filter(l => l.studentCountryCode === this.currentLocationFilter);
                }

                tbody.innerHTML = lessons.slice(-20).reverse().map(lesson => {
                    const phone = (lesson.studentCountryCode || '') + ' ' + (lesson.studentPhone || '');
                    const subject = lesson.subject === 'custom' ? `Custom: ${lesson.customSubject}` : lesson.subject;

                    return `
                        <tr>
                            <td>${new Date(lesson.timestamp).toLocaleDateString()}</td>
                            <td>${lesson.studentName || 'New Student'}<br><small>${lesson.studentEmail}</small></td>
                            <td>${phone}</td>
                            <td>${subject || 'General Math'}</td>
                            <td>${lesson.duration || '60'} min</td>
                            <td><span class="status-badge status-${lesson.status}">${lesson.status}</span></td>
                            <td>
                                <button class="action-btn" title="Accept" onclick="updateLessonStatus('${lesson.id}', 'accepted')">‚úì</button>
                                <button class="action-btn" title="Decline" onclick="updateLessonStatus('${lesson.id}', 'declined')">‚úó</button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No lesson requests found</td></tr>';
            }

            populateLocationFilter() {
                const locations = new Set();
                this.data.lessons.forEach(l => {
                    if (l.studentCountryCode) locations.add(l.studentCountryCode);
                });

                // Also check payments if available
                this.data.payments.forEach(p => {
                    if (p.country) locations.add(p.country);
                });

                const select = document.getElementById('location-filter');
                if (!select) return;

                const current = select.value;
                select.innerHTML = '<option value="all">All Locations</option>';

                locations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = this.getCountryName(loc);
                    select.appendChild(opt);
                });

                select.value = current;
            }

            getCountryName(code) {
                const names = {
                    'IL': 'Israel', 'US': 'United States', 'GB': 'United Kingdom', 'RU': 'Russia',
                    'AE': 'UAE', 'SA': 'Saudi Arabia', 'EG': 'Egypt', 'JO': 'Jordan'
                };
                return names[code] || code;
            }
        }


        // Initialize Data Manager
        const dataManager = new DataManager();

        // UI Functions
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(`${sectionId}-section`).classList.add('active');

            // Add active class to clicked nav link
            event.target.closest('.nav-link').classList.add('active');
        }

        function refreshData() {
            dataManager.loadData();
            // Removed alert to be less annoying
        }

        async function clearUsers() {
            if (!confirm('Are you certain you want to delete ALL users? This action is irreversible.')) return;

            try {
                const response = await fetch('/api/admin/users', { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    dataManager.loadData();
                } else {
                    alert('Failed: ' + result.message);
                }
            } catch (e) {
                console.error(e);
                alert('Error connecting to server to clear users');
            }
        }

        function addUser() {
            document.getElementById('add-user-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function saveUser(event) {
            event.preventDefault();

            const user = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                type: document.getElementById('user-type').value,
                notes: document.getElementById('user-notes').value
            };

            dataManager.addUser(user);
            closeModal('add-user-modal');

            // Reset form
            event.target.reset();
        }

        function toggleDataCollection() {
            const checkbox = document.getElementById('data-collection');
            const status = document.getElementById('data-status');

            if (checkbox.checked) {
                status.textContent = 'Active - Collecting data from main site';
                localStorage.setItem('tensor_data_collection', 'enabled');
            } else {
                status.textContent = 'Disabled - Not collecting data';
                localStorage.setItem('tensor_data_collection', 'disabled');
            }
        }

        function exportData() {
            dataManager.exportData();
        }

        function exportCSV() {
            dataManager.exportCSV();
        }

        function backupData() {
            dataManager.backupData();
        }

        function clearAllData() {
            dataManager.clearAllData();
        }

        async function updateLessonStatus(id, status) {
            try {
                const response = await fetch('/api/admin/lessons/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, status })
                });

                if (response.ok) {
                    // Reload data to show updated status
                    await dataManager.loadData();
                } else {
                    alert('Failed to update status');
                }
            } catch (e) {
                console.error('Error updating status:', e);
            }
        }

        async function performServerBackup() {
            if (!confirm('Create a backup of all server database files?')) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;

            try {
                btn.innerHTML = 'Creating...';
                btn.disabled = true;

                const response = await fetch('/api/admin/database/backup', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                } else {
                    alert('Backup failed: ' + result.message);
                }
            } catch (e) {
                alert('Error connecting to server');
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function addSampleData() {
            console.log("Sample data generation is disabled.");
        }

        // Auto-add sample data if no data exists
        // Auto-add sample data if no data exists
        // setTimeout(addSampleData, 1000); // Disabled to allow clearing data
        // setTimeout(addSampleData, 1000); // Disabled to allow clearing data

        // --- CMS Logic ---
        async function loadCourses() {
            try {
                const response = await fetch('/api/courses');
                const courses = await response.json();
                const container = document.getElementById('courses-grid');
                if (!container) return;

                container.innerHTML = Object.values(courses).map(course => `
            <div style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 1rem; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h3 style="color: var(--gold); margin:0;">${course.id}</h3>
                    <div>
                        <button onclick="editCourse('${course.id}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">‚úèÔ∏è</button>
                        <button onclick="deleteCourse('${course.id}')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">üóëÔ∏è</button>
                    </div>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">${course.en?.title || 'No English Title'}</p>
                <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 0.5rem;">
                    <small style="color: var(--text-muted);">Videos: ${course.videos ? course.videos.length : 0}</small>
                    <button onclick="manageVideos('${course.id}')" class="btn btn-primary" style="width:100%; margin-top:0.5rem; font-size:0.8rem;">Manage Videos</button>
                </div>
            </div>
            `).join('');
            } catch (e) {
                console.error('Failed to load courses', e);
            }
        }

        async function editCourse(id) {
            const newTitle = prompt("Enter new English title for " + id);
            if (newTitle) {
                const courses = await (await fetch('/api/courses')).json();
                const course = courses[id];
                course.en.title = newTitle;

                await fetch('/api/courses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, data: course })
                });
                loadCourses();
            }
        }

        async function deleteCourse(id) {
            if (!confirm(`Delete course ${id}?`)) return;
            await fetch(`/api/courses/${id}`, { method: 'DELETE' });
            loadCourses();
        }

        let currentCourseIdForVideos = null;
        async function manageVideos(id) {
            currentCourseIdForVideos = id;
            const courses = await (await fetch('/api/courses')).json();
            const course = courses[id];

            let vModal = document.getElementById('video-modal');
            if (!vModal) {
                vModal = document.createElement('div');
                vModal.id = 'video-modal';
                vModal.className = 'modal active';
                // vModal.style.display = 'flex'; // Handled by class
                vModal.innerHTML = `
            <div class="auth-modal" style="width: 600px; max-width:90%; background: #0b0f16; border: 1px solid #2a2f3a; padding: 2rem;">
                <button class="modal-close" style="float:right; cursor:pointer;" onclick="document.getElementById('video-modal').style.display='none'">√ó</button>
                <h2 id="vm-title" style="color: #d4af37;">Manage Videos</h2>
                <div id="vm-list" style="margin: 1rem 0; max-height: 300px; overflow-y: auto;"></div>
                <div style="border-top: 1px solid #2a2f3a; padding-top: 1rem;">
                    <h4 style="color:#d4af37;">Add Video</h4>
                    <input id="vm-vid-title" placeholder="Video Title" class="form-input" style="margin-bottom:0.5rem;">
                        <input id="vm-vid-url" placeholder="Video URL (YouTube/MP4)" class="form-input" style="margin-bottom:0.5rem;width:100%;">
                            <button onclick="addVideo()" class="btn btn-primary">Add Video</button>
                        </div>
                </div>
                `;
                document.body.appendChild(vModal);
            } else {
                vModal.style.display = 'flex';
            }

            document.getElementById('vm-title').textContent = `Videos: ${course.en.title}`;
            renderVideoList(course.videos || []);
        }

        function renderVideoList(videos) {
            const list = document.getElementById('vm-list');
            list.innerHTML = videos.map(v => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:0.5rem; margin-bottom:0.5rem; border-radius:4px;">
                    <div>
                        <div style="font-weight:bold;color:#eee;">${v.title}</div>
                        <div style="font-size:0.8rem; color:#aaa;">${v.url}</div>
                    </div>
                    <button onclick="removeVideo('${v.id}')" style="color:#ef4444; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
                </div>
                `).join('') || '<p style="color:#aaa;">No videos yet.</p>';
        }

        async function addVideo() {
            const title = document.getElementById('vm-vid-title').value;
            const url = document.getElementById('vm-vid-url').value;
            if (!title || !url) return alert('Enter title and URL');

            const res = await fetch(`/api/courses/${currentCourseIdForVideos}/videos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, url })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('vm-vid-title').value = '';
                document.getElementById('vm-vid-url').value = '';
                manageVideos(currentCourseIdForVideos);
                loadCourses();
            }
        }

        async function removeVideo(vidId) {
            if (!confirm('Deleting video...')) return;
            await fetch(`/api/courses/${currentCourseIdForVideos}/videos/${vidId}`, { method: 'DELETE' });
            manageVideos(currentCourseIdForVideos);
            loadCourses();
        }

        function openCourseModal() {
            const id = prompt("Course ID (e.g., MTH-301):");
            if (!id) return;
            const title = prompt("English Title:");
            if (!title) return;

            fetch('/api/courses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id,
                    data: {
                        id,
                        en: { title, description: "New Course", syllabus: [], duration: "TBD", level: "All" }
                    }
                })
            }).then(() => loadCourses());
        }

        // Initialize CMS
        loadCourses();
        function applyLocationFilter() {
            const select = document.getElementById('location-filter');
            if (window.dataManager) {
                window.dataManager.currentLocationFilter = select.value;
                window.dataManager.updateAllTables();
                // Optionally verify if charts should be filtered too
                // window.dataManager.updateAllCharts(); 
            }
        }
    </script>
</body>

</html>